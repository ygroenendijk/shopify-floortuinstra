{%- comment -%} Import styles for this section {%- endcomment -%}
{%- liquid
  # Styles based on swiper_indication setting
  case section.settings.swiper_indication
    when 'pagination'
      assign swiper_indication_class = ' swiper-pagination-active'
    when 'scrollbar'
      assign swiper_indication_class = ' swiper-scrollbar-active'
    else
      assign swiper_indication_class = ''
  endcase

  if recommendations.performed? and recommendations.products_count > 0
    assign object_array = recommendations.products
  else
    assign object_array = product.collections.first.products
  endif
-%}

{%- comment -%} Render the content {%- endcomment -%}
{%- if object_array.size > 0 -%}
  {%- capture container_content -%}
    {%- render 'swiper-content',
      object_array: object_array,
      is_recommendations: true,
      custom_element: 'product-recommendations',
      render_products: true,
      max_count: section.settings.limit,
      index_on_page: section.index,
      id: section.id,
      container_width: section.settings.container_width,
      swiper_indication: section.settings.swiper_indication,
      swiper_navigation: section.settings.swiper_navigation,
      swiper_autoplay: section.settings.swiper_autoplay,
      swiper_autoplay_delay: section.settings.swiper_autoplay_delay
    -%}
  {% comment %} <product-recommendations {{ swiper_options }}>
      <div class="swiper relative overflow-visible
        [--swiper-spaceBetween:16px]
        [--swiper-slidesPerView:1.2]
        xs:[--swiper-slidesPerView:2]
        md:[--swiper-spaceBetween:32px]
        md:[--swiper-slidesPerView:3]
        lg:[--swiper-slidesPerView:4]
        ">

        {%- comment -%} Render swiper navigation {%- endcomment -%}
        {%- if section.settings.swiper_navigation -%}
          <div class="content-wrapper absolute inset-x-4 inset-y-0 md:inset-x-8">
            <button
              class="swiper-button-prev swiper-button-prev-{{ section.id }} {% if section.settings.swiper_indication != '' %}translate-y-[-50%]{%- endif -%}"
              aria-label="{% render "render-translation", namespace: "accessibility", key: "previous_slide", fallback: "Previous slide" %}"
            >
              {%- render 'icons', icon: 'chevron-left', icon_class: 'w-5' -%}
            </button>
            <button
              class="swiper-button-next swiper-button-next-{{ section.id }} {% if section.settings.swiper_indication != '' %}translate-y-[-50%]{%- endif -%}"
              aria-label="{% render "render-translation", namespace: "accessibility", key: "next_slide", fallback: "Next slide" %}"
            >
              {%- render 'icons', icon: 'chevron-right', icon_class: 'w-5' -%}
            </button>
          </div>
        {%- endif -%}

        <div class="overflow-hidden {{ swiper_indication_class }} 2xl:px-[var(--content-wrapper-padding)]" data-swiper>
          <div class="swiper-wrapper flex" data-recommended-products>
            {%- if recommendations.performed? and recommendations.products_count > 0 -%}
              {%- for recommendation in recommendations.products -%}
                <div class="swiper-slide">
                  {%- render 'product-card', product_object: recommendation -%}
                </div>
              {%- endfor -%}
            {%- else -%}
              {%- comment -%} Prefill collection slider to prevent CLS scores {%- endcomment -%}
              {%- assign coll = product.collections.first -%}
              {%- for col_product in coll.products limit: 6 -%}
                <div class="swiper-slide">
                  {%- render 'product-card', product_object: col_product -%}
                </div>
              {%- endfor -%}
            {%- endif -%}
          </div>        {%- comment -%} Render swiper indication {%- endcomment -%}


          {%- if section.settings.swiper_indication != '' -%}
            <div class="content-wrapper content-wrapper-padding 2xl:px-0">
          {%- endif -%}
          {%- case section.settings.swiper_indication -%}
            {%- when 'pagination' -%}
              <div class="swiper-pagination swiper-pagination-{{ section.id }}"></div>
              {%- when 'scrollbar' -%}
                <div class="swiper-scrollbar swiper-scrollbar-{{ section.id }}"></div>
          {%- endcase -%}
          {%- if section.settings.swiper_indication != '' -%}
            </div>
          {%- endif -%}
        </div>
      </div>
    </product-recommendations>  {% endcomment %}
  {%- endcapture -%}

  {%- comment -%} Capture container data with url from where to fetch recommendations {%- endcomment -%}
  {%- capture container_data -%}
    {%- if product.id -%}
      data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&intent={{ section.settings.intent }}&limit={{ section.settings.limit }}"
    {%- endif -%}
  {%- endcapture -%}

  {%- liquid
    # Container class
    assign container_class = 'product-recommendations block overflow-hidden ' | append: section.settings.container_width
    if section.settings.color_scheme != blank
      assign container_class = container_class | append: ' container--background my-0 group/color-scheme ' | append: section.settings.color_scheme
    endif
  -%}

  {%- render 'render-container-content',
    tag: 'product-recommendations',
    data: container_data,
    title: section.settings.heading,
    title_class: 'h4 product-recommendations__heading',
    class: container_class,
    content: container_content,
    content_class: 'p-0'
  -%}
{%- endif -%}

{% schema %}
  {
    "name": "Product recommendations",
    "tag": "section",
    "limit": 1,
    "class": "product-recommendation-section",
    "settings": [
      {
        "type": "paragraph",
        "content": "Dynamic recommendations use order and product information to change and improve over time. [Learn more](https://help.shopify.com/en/themes/development/recommended-products)"
      },
      {
        "type": "select",
        "id": "container_width",
        "label": "Section content width",
        "default": "",
        "options": [
          {
            "value": "",
            "label": "Default"
          },
          {
            "value": "container--wide",
            "label": "Wide"
          }
        ]
      },
      {
        "type": "select",
        "id": "color_scheme",
        "default": "",
        "label": "Color scheme",
        "options": [
          {
            "value": "",
            "label": "Default"
          },
          {
            "value": "color-scheme color-scheme--gray",
            "label": "Gray"
          }
        ]
      },
      {
        "type": "text",
        "id": "heading",
        "default": "Recommendations",
        "label": "Heading"
      },
      {
        "type": "select",
        "id": "intent",
        "label": "Intent",
        "options": [
          {
            "value": "related",
            "label": "Related"
          },
          {
            "value": "complementary",
            "label": "Complementary"
          }
        ],
        "default": "related",
        "info": "Recommended products for each intent can be configured via the Shopify Search & Discovery app. [Read more](https://shopify.dev/themes/product-merchandising/recommendations#recommendation-intents) about recommendation intents."
      },
      {
        "type": "range",
        "id": "limit",
        "min": 2,
        "max": 10,
        "step": 1,
        "label": "Limit",
        "default": 8,
        "info": "Limits the number of results. The value can range from 1 to 10."
      },
      {
        "type": "header",
        "content": "Slider settings"
      },
      {
        "type": "select",
        "id": "swiper_indication",
        "label": "Slider indication",
        "default": "pagination",
        "options": [
          {
            "value": "",
            "label": "None"
          },
          {
            "value": "pagination",
            "label": "Pagination"
          },
          {
            "value": "scrollbar",
            "label": "Scrollbar"
          }
        ]
      },
      {
        "type": "checkbox",
        "id": "swiper_navigation",
        "label": "Show Navigation",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "swiper_autoplay",
        "label": "Enable autoplay",
        "default": false
      },
      {
        "type": "number",
        "id": "swiper_autoplay_delay",
        "label": "Autoplay delay",
        "default": 7500,
        "info": "Delay between transitions (in ms)"
      }
    ],
    "presets": [
      {
        "name": "Product recommendations"
      }
    ],
    "enabled_on": {
      "templates": ["product"]
    }
  }
{% endschema %}
